version: '3.8'

services:
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: portfolio-os-backend
    ports:
      - '3000:3000'
    environment:
      NODE_ENV: ${NODE_ENV:-production}
      PORT: 3000
      OPENAI_API_KEY: ${OPENAI_API_KEY}
      JWT_SECRET: ${JWT_SECRET}
      WEBHOOK_SECRET: ${WEBHOOK_SECRET}
      MASTER_SECRET: ${MASTER_SECRET}
      QDRANT_URL: http://qdrant:6333
      QDRANT_API_KEY: ${QDRANT_API_KEY:-}
      TELEGRAM_BOT_TOKEN: ${TELEGRAM_BOT_TOKEN:-}
      TELEGRAM_CHAT_ID: ${TELEGRAM_CHAT_ID:-}
      DISCORD_WEBHOOK_URL: ${DISCORD_WEBHOOK_URL:-}
      LOG_LEVEL: ${LOG_LEVEL:-info}
      ENABLE_TELEMETRY: ${ENABLE_TELEMETRY:-true}
      TRACK_QUERIES: ${TRACK_QUERIES:-true}
    volumes:
      - ./data:/data
      - ./logs:/app/logs
    depends_on:
      qdrant:
        condition: service_healthy
    restart: unless-stopped
    networks:
      - portfolio-net
    healthcheck:
      test: ['CMD-SHELL', 'curl -f http://localhost:3000/health || exit 1']
      interval: 10s
      timeout: 5s
      retries: 30
      start_period: 30s

  qdrant:
    image: qdrant/qdrant:latest
    container_name: portfolio-os-qdrant
    ports:
      - '6333:6333'
      - '6334:6334'
    environment:
      QDRANT_API_KEY: ${QDRANT_API_KEY:-}
    volumes:
      - qdrant-data:/qdrant/storage
    restart: unless-stopped
    networks:
      - portfolio-net
    healthcheck:
      test: ['CMD-SHELL', 'curl -f http://localhost:6333/health || exit 1']
      interval: 10s
      timeout: 5s
      retries: 30
      start_period: 15s

volumes:
  qdrant-data:

networks:
  portfolio-net:
    driver: bridge
